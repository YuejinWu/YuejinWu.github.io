<!DOCTYPE html><html lang="en &amp;&amp; zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>§16 Query Optimization 解读 | Yuejin's Blog</title><meta name="keywords" content="Database"><meta name="author" content="Yuejin Wu"><meta name="copyright" content="Yuejin Wu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="§16 Query Optimization 解读"><meta name="application-name" content="§16 Query Optimization 解读"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="§16 Query Optimization 解读"><meta property="og:url" content="http://example.com/2025/12/28/DB_QueryOptim/index.html"><meta property="og:site_name" content="Yuejin's Blog"><meta property="og:description" content="数据库查询优化  讲义 第一章：查询优化概述 1.1 查询优化的必要性与定义 1.1.1 问题背景 在数据库系统中，一个SQL查询语句可以对应多个等价的关系代数表达式。例如，连接操作的顺序不同、选择操作的位置不同，都会产生不同的执行路径。这些不同的执行路径在实际执行时会产生显著不同的代价，包括磁盘I"><meta property="og:locale" content="en &amp;&amp; zh-Hans"><meta property="og:image" content="http://example.com/img/C7_cover.png"><meta property="article:author" content="Yuejin Wu"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://example.com/img/C7_cover.png"><meta name="description" content="数据库查询优化  讲义 第一章：查询优化概述 1.1 查询优化的必要性与定义 1.1.1 问题背景 在数据库系统中，一个SQL查询语句可以对应多个等价的关系代数表达式。例如，连接操作的顺序不同、选择操作的位置不同，都会产生不同的执行路径。这些不同的执行路径在实际执行时会产生显著不同的代价，包括磁盘I"><link rel="shortcut icon" href="/img/mylogo.jpg"><link rel="canonical" href="http://example.com/2025/12/28/DB_QueryOptim/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@6.1.6/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2024/07/27/125766904/ba62475f396df9de3316a08ed9e65d86_5680958632268053399..png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":null,"LingQueMonitorID":null},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: Yuejin Wu","link":"链接: ","source":"来源: Yuejin's Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.2.0/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.2.0/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'Yuejin's Blog',
  title: '§16 Query Optimization 解读',
  postAI: '',
  pageFillDescription: '数据库查询优化  讲义, 第一章：查询优化概述, 1.1 查询优化的必要性与定义, 1.1.1 问题背景, 1.1.2 查询优化的核心目标, 1.1.3 示例：一个简单查询的多种可能, 1.2 评估计划的组成, 1.3 查询优化的三阶段流程, 阶段一：生成等价表达式, 阶段二：生成候选评估计划, 阶段三：选择最优计划, 第二章：关系表达式的等价转换, 2.1 等价性的严格定义, 2.2 核心等价规则详解, 规则1：选择操作的串接律 (Cascading of Selections), 规则2：选择操作的交换律 (Commutativity of Selections), 规则3：投影操作的串接律 (Cascading of Projections), 规则4：用连接操作替代选择和笛卡尔积, 规则5：连接操作的交换律 (Commutativity of Theta Joins), 规则6：连接操作的结合律 (Associativity of Joins), 规则7：选择操作对连接的分配律, 规则8：投影操作对连接的分配律, 规则9-12：集合操作的规则, 2.3 综合转换示例, 示例一：选择下推 (Pushing Selections), 示例二：结合律与选择下推结合, 示例三：投影下推, 第三章：连接顺序优化, 3.1 问题的重要性, 3.2 核心原则, 3.3 基于启发式的连接排序, 3.4 结合统计信息的动态规划算法（简述）, 第四章：评估计划的选择与启发式优化, 4.1 查询优化的最终任务, 4.2 启发式优化：基于经验的快速优化, 4.2.1 核心启发式规则, 4.2.2 启发式优化的系统化步骤, 4.3 综合示例分析, 示例一：查询成绩gt90的男生姓名, 示例二：保险数据库查询, 示例四：银行数据库复杂查询, 第五章：总结与范畴, 5.1 为什么需要查询优化？, 5.2 查询优化的三大支柱, 5.3 优化方法分类, 5.4 相关高级主题数据库查询优化讲义第一章查询优化概述查询优化的必要性与定义问题背景在数据库系统中一个查询语句可以对应多个等价的关系代数表达式例如连接操作的顺序不同选择操作的位置不同都会产生不同的执行路径这些不同的执行路径在实际执行时会产生显著不同的代价包括磁盘次数处理时间内存使用量等查询优化的核心目标查询优化就是数据库管理系统在多个等价的执行计划中自动选择并生成一个代价最低或接近最低的评估计划的过程其根本目的是在保证查询结果正确的前提下最小化查询执行的总成本示例一个简单查询的多种可能考虑一个简单的连接查询这个查询至少对应两种关系代数表达式先做笛卡尔积再做选择直接做等值连接显然第二种方式直接连接的效率远高于第一种先做代价高昂的笛卡尔积查询优化器的任务之一就是避免生成第一种低效的计划评估计划的组成一个完整的评估计划需要明确两件事操作算法为计划中的每个关系代数操作选择投影连接等选择具体的实现算法例如选择操作是用线性扫描还是索引扫描连接操作是用嵌套循环归并连接还是哈希连接执行协调确定操作之间的执行协调方式是采用物化策略将中间结果临时存储到磁盘还是采用流水线策略一个操作的输出直接作为下一个操作的输入图示示例一个包含流水线的评估计划去除重复归并连接流水线流水线使用索引图一个包含了归并连接流水线传递和索引访问的查询评估计划示例查询优化的三阶段流程查询优化是一个系统化的过程通常分为三个阶段阶段一生成等价表达式输入由查询解析器产生的初始关系代数表达式或查询树过程应用一系列等价规则如选择下推连接交换律等对初始表达式进行变换生成一系列在逻辑上等价的候选表达式输出一组等价的查询树表达式集合阶段二生成候选评估计划过程为第一阶段生成的每个等价表达式标注上具体的物理操作算法和协调策略例如标注某个选择操作使用在属性上的树索引查找算法标注两个关系的连接使用基于哈希的连接算法输出一组完整的可执行的候选评估计划阶段三选择最优计划过程基于数据库系统的统计信息如关系的大小属性的取值分布索引的存在等估算每个候选计划的执行代价方法基于代价的优化建立一个代价模型精确或近似计算每个计划的代价选择最小的启发式优化应用一系列经验规则启发式快速选择一个大概率较优的计划不进行精确的代价比较输出一个被选中的优化后的查询评估计划交由查询执行引擎运行第二章关系表达式的等价转换等价性的严格定义两个关系代数表达式和是等价的记作当且仅当对于任何合法的数据库实例即任何符合模式的数据集合和的计算结果都产生完全相同的元组集合包括顺序如果考虑有序关系等价转换是查询优化的代数基础它保证了我们变换查询形式时不会改变查询结果的正确性核心等价规则详解规则选择操作的串接律公式含义一个包含合取的选择条件可以拆分为两个连续的选择操作顺序可以任意作用为后续将单个选择条件下推到表达式树的不同分支创造条件示例查找工资高于万且属于计算机系的教师原式可转换为规则选择操作的交换律公式含义多个连续选择操作的执行顺序可以任意交换作用结合规则使得优化器可以灵活地安排选择条件的评估顺序例如将选择性更强能过滤掉更多元组的条件先执行规则投影操作的串接律公式若则含义如果一串投影操作中每个后续的投影属性列表都包含前一个的那么只有最后一个投影是必要的作用在优化过程中可以消除中间不必要的投影操作示例只需要教师的原式可简化为规则用连接操作替代选择和笛卡尔积这是将低效操作转换为高效操作的关键规则公式公式更一般地选择条件可以下推到笛卡尔积的一个操作数上其中只涉及的属性是连接条件或涉及两个关系的条件含义与作用优化器应始终避免显式生成笛卡尔积任何计划中如果出现笛卡尔积后接选择都应转换为等价的连接操作连接算法如嵌套循环哈希归并的效率远高于计算完整的笛卡尔积示例查询系的教师及其授课信息低效原式理论上优化器应避免生成优化后规则连接操作的交换律公式含义连接操作的左右操作数可以交换作用这对于选择连接顺序至关重要它允许优化器将尺寸较小的关系作为连接操作的外关系性能分析考虑嵌套循环连接外层关系有个元组内层关系有个元组如果有基于连接属性的树索引则连接代价约为其中是树的度如果有索引则代价约为结论应将元组数少的关系作为外关系因为或的系数是而乘以对数项的系数是另一个关系的大小通常让较小的关系驱动循环更优形式化推导设比较两种顺序的代价差当和不太小时该值通常为正说明小大的代价低于大小规则连接操作的结合律公式自然连接公式连接其中只涉及和的属性含义与作用多表连接的顺序可以改变这是连接顺序优化的代数基础通过改变结合顺序可以优先连接产生较小中间结果的关系对从而降低整个查询的代价规则选择操作对连接的分配律这是尽早执行选择原则的代数依据公式如果选择条件只涉及的属性则公式如果选择条件是合取式且只涉及的属性只涉及的属性则作用将选择操作从连接之后下推到连接之前甚至下推到单个关系上这能显著减少参与连接操作的数据量是降低连接代价最有效的手段之一规则投影操作对连接的分配律这是尽早执行投影原则的代数依据公式简单情况设是的属性子集是的属性子集如果连接条件涉及的所有属性都包含在中那么公式复杂情况如果连接条件涉及一些不在最终投影列表中的属性那么下推投影时必须把这些属性也保留下来否则无法进行连接设是中参与连接条件但不在中的属性设是中参与连接条件但不在中的属性则作用在连接前就剔除那些后续操作和最终结果都不需要的属性减少每个元组的大小这能降低数据在磁盘和内存之间传输的代价并允许更多的元组装入同一个内存块或缓冲区规则集合操作的规则规则并集和交集满足交换律差集不满足规则并集和交集满足结合律规则选择操作对并交差满足分配律交和差同理规则投影操作对并集满足分配律注意投影对交集和差集不满足分配律例如因为可能有一些元组在投影后变得相同在右边会被错误地消除综合转换示例示例一选择下推查询找出系所有教师的姓名及其所授课程的名称初始表达式连接后进行选择和投影应用规则将选择操作下推到它只涉及的关系上效果连接操作现在只需处理中属于系的一小部分元组而不是全部代价大大降低示例二结合律与选择下推结合查询找出在年授课的系教师的姓名及其课程名称初始表达式步骤应用结合律规则明确连接顺序假设优化器决定先连接和步骤应用选择分配律规则将合取选择拆开并下推效果两个连接操作都在已经被大幅过滤的小关系上进行效率极高示例三投影下推继续示例一的优化后表达式分析中间结果模式的模式的模式它们连接后的模式包含所有属性但最终我们只需要和来自表通过连接应用投影下推规则对分支最终需要连接需要因此投影为对分支连接需要和最终结果需要用于连接表因此投影为对分支已投影为最终优化表达式效果每个中间关系都只包含最少的必要属性数据体积最小化和内存开销显著降低第三章连接顺序优化问题的重要性对于涉及多个关系例如个以上的连接查询可能的连接顺序数量随着关系数增长而呈指数级增长是卡特兰数不同的连接顺序会产生大小差异巨大的中间结果从而导致总执行代价的天壤之别核心原则连接顺序优化的基本原则是使执行过程中产生的临时关系最小化更小的中间结果意味着更少的磁盘写入读取更少的内存占用更快的后续处理速度实现这一原则的策略是优先连接产生最小结果集的关系对基于启发式的连接排序虽然没有统计信息时无法精确判断但一些启发式规则很有用进行有选择操作的关系优先连接如果某个关系上有能大幅过滤元组的选择条件如那么先对这个关系进行选择再与其他关系连接因为选择后关系变小了小关系优先连接如果已知某些关系本身很小元组数少让它们先连接使用有索引的外键关系优先连接如果一个关系可以通过索引快速连接到另一个关系这种连接方式成本较低可以优先考虑结合统计信息的动态规划算法简述在实际的基于代价的优化器中如的优化器常使用动态规划算法来选择多表连接顺序基础对于单个关系最佳计划就是访问它的最佳方式全表扫描或索引扫描递推对于关系集合其最佳连接计划可以通过考察所有将划分为两个非空子集和的方式计算最佳计划最佳计划的代价并取最小值代价估算每一步的代价估算都需要利用数据库的统计信息如每个关系的元组数每个属性的不同值数量属性的最小值最大值索引的深度叶节点数等剪枝搜索空间巨大需要利用代价上界等进行剪枝第四章评估计划的选择与启发式优化查询优化的最终任务为给定的关系代数表达式生成一个物理执行计划该计划逻辑正确能产生与原表达式完全相同的结果代价较低相较于其他候选计划其预估执行代价较小可执行明确了每个操作的算法和资源使用方式启发式优化基于经验的快速优化由于基于代价的优化搜索空间大统计信息可能不准或缺失启发式优化是一种实用且高效的替代方案它不追求数学上的最优解而是应用一套经验证明有效的规则快速得到一个足够好的计划核心启发式规则尽早执行选择操作理由选择操作通常能大幅减少元组数量元组越少后续所有操作投影连接集合操作的代价都越低实现利用规则将操作尽可能下推到查询树的叶节点尽早执行投影操作理由投影操作减少每个元组的宽度属性数更窄的元组意味着在磁盘和内存间传输时每个块能容纳更多元组减少次数同样大小的内存缓冲区能容纳更多元组实现利用规则在保证连接条件属性不丢失的前提下将操作下推用连接操作替代笛卡尔积理由笛卡尔积的代价是乘积级的而等值连接的代价可以低很多如有索引可到级别实现利用规则优化器在生成计划时应避免任何显式的笛卡尔积总是直接生成连接先执行最严格的操作理由最严格的操作指能产生最小输出结果的操作先执行它们能为后续操作创造更小的输入实现结合统计信息或简单启发式如等值条件通常比范围条件严格小表上的选择比大表上的选择严格对操作排序启发式优化的系统化步骤可以将启发式规则整合为一个系统化的查询树转换流程步骤分解合取选择应用规则将形如的表达式分解为一系列单个选择目的为每个独立的选择条件下推创造条件步骤选择操作下推对查询树从根到叶进行遍历对于每一个选择操作应用规则交换律和规则分配律尝试将其下推穿过其子操作如连接笛卡尔积并集等目标是让每个都尽可能靠近叶节点最终作用在单个基关系上目的实现尽早选择步骤重新安排叶节点连接顺序应用规则交换律和规则结合律对查询树中的叶节点基关系进行重新排序启发式将具有最严格选择条件即能产生最小结果集的关系安排在连接顺序中尽可能早的位置目的让连接操作从一开始就在小关系上进行步骤用连接替代笛卡尔积和选择查找查询树中任何笛卡尔积后接选择的模式应用规则将其直接替换为一个连接操作目的消除代价极高的笛卡尔积步骤投影操作下推对查询树从根到叶进行遍历对于每一个投影操作应用规则串接律消除冗余投影和规则分配律尝试将其下推下推时需特别注意保留连接条件所需的属性规则的复杂情况目的实现尽早投影减少数据体积综合示例分析示例一查询成绩的男生姓名数据库模式查询初始关系代数表达式可能由解析器生成注意这里出现了笛卡尔积是优化器需要消除的低效形式启发式优化过程假设更优的初始表达式实际优化器可能直接生成带连接的表达式我们从这个更合理的起点开始优化选择下推应用规则得到投影下推分析最终需要连接条件是因此对分支需要和投影为对分支连接需要最终结果不需要的任何属性但连接需要投影为但注意的选择条件需要属性所以投影必须在选择之后进行且选择条件需要所以投影无法完全下推到选择之前这里我们先做选择再做投影更精确的转换利用规则设最终投影列表对于左子树需要保留属性以及连接属性所以先投影为但选择条件不需要额外属性所以顺序可以是对于右子树最终结果不需要它的属性连接属性所以先投影为但选择条件需要所以实际是最终优化表达式最终优化的查询树示例二保险数据库查询数据库模式本查询未使用查询找出年月日前在北京发生的交通事故的驾驶员姓名车牌号和事故报告编号优化过程与最终查询树选择下推将下推到表投影下推在连接前仅保留必要属性表最终需要连接需要投影为表连接需要和最终需要投影为表连接需要选择需要和最终需要投影为但选择条件需要所以先选择再投影连接顺序由于经过严格选择后可能变得很小可以优先与连接最终优化查询树示例四银行数据库复杂查询数据库模式查询找出在市资产超过万美元的分行中办理了贷款金额小于美元的客户姓名两种视角的优化方案方案一逻辑优化关系代数层面选择下推下推到表下推到表投影下推表连接需要最终结果不需要它的属性投影为选择条件需要所以先选择再投影表连接需要和最终结果不需要它的属性投影为选择条件需要表连接需要最终需要投影为连接顺序可以先连接产生在特定分行的小额贷款的列表再与连接获取客户名优化查询树逻辑方案二物理优化结合存储和索引假设有以下物理结构表在上有复合树索引访问方式索引查找找到满足条件的列表表在上有树索引在上有索引访问方式对进行索引扫描再与来自的列表进行过滤可能用嵌套循环连接表堆文件在上有非聚簇索引物理执行计划可能描述为对使用索引查找得到结果集列表对使用在上的索引扫描对每个扫描到的元组检查其是否在集合中嵌套循环内连接并通过上的索引查找表索引嵌套循环连接从找到的元组中提取这个计划充分利用了现有索引避免了全表扫描尽管连接算法是嵌套循环但由于内层有索引支持效率依然很高第五章总结与范畴为什么需要查询优化性能差异巨大同一查询的不同执行计划其代价可能相差数个数量级用户透明性让用户专注于声明要什么而无需操心怎么要执行细节系统资源高效利用自动选择最佳计划节省和内存资源查询优化的三大支柱关系表达式的等价转换第章代数基础通过等价规则生成多个逻辑上等价的候选表达式表达式结果的统计信息估算第章代价估算的基础需要估算中间结果的大小基数不同值数量数据分布等例如选择操作的结果大小估算依赖于选择条件的选择率连接操作的结果大小估算依赖于连接属性的域大小和值的分布查询执行计划的选择第章综合应用前两者从候选计划中选出代价最低的优化方法分类基于代价的优化优点理论上能找到最优解缺点搜索空间大依赖准确的统计信息优化过程本身有开销适用于对性能要求极高数据分布稳定的场景启发式优化优点简单快速开销小不依赖精确统计信息缺点可能错过最优计划得到的是较好而非最好的计划适用于场景或统计信息缺失时现代优化器通常结合两者先使用启发式规则大幅缩小搜索空间再在剩余空间内进行基于代价的精细选择相关高级主题物化视图第章将某些常用查询尤其是包含聚集连接的复杂查询的结果预先计算并存储为真实的表查询优化器可以重写用户查询使其直接访问物化视图从而避免昂贵的连接和计算开销嵌套子查询优化问题中的嵌套子查询如等通常以低效的逐行处理方式执行优化将嵌套子查询去相关化转换为等价的连接操作从而可以利用连接优化技术例如可以转换为通过学习本章内容读者应能深入理解数据库查询优化器的工作原理从而能够编写更能被优化器高效处理的语句理解数据库给出的执行计划并据此进行性能调优在设计数据库模式如索引物化视图时考虑其对查询优化的影响讲义结束',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-12-28 01:24:03',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><style>
  /* === 只添加半透明磨砂效果，不改变任何布局 === */
  
  /* 1. 导航栏内所有可点击元素添加磨砂背景 */
  #nav a,
  #nav button {
    /* 保持原有布局，只添加背景效果 */
    backdrop-filter: blur(6px) !important;
    -webkit-backdrop-filter: blur(6px) !important;
    transition: backdrop-filter 0.3s ease !important;
  }
  
  /* 2. 浅色模式：白色半透明 */
  body:not([data-theme="dark"]) #nav a,
  body:not([data-theme="dark"]) #nav button {
    background-color: rgba(255, 255, 255, 0.1) !important;
  }
  
  /* 3. 深色模式：黑色半透明 */
  [data-theme="dark"] #nav a,
  [data-theme="dark"] #nav button {
    background-color: rgba(0, 0, 0, 0.1) !important;
  }
  
  /* 4. 悬停效果：稍微增加透明度 */
  #nav a:hover,
  #nav button:hover {
    backdrop-filter: blur(8px) !important;
    -webkit-backdrop-filter: blur(8px) !important;
  }
  
  body:not([data-theme="dark"]) #nav a:hover,
  body:not([data-theme="dark"]) #nav button:hover {
    background-color: rgba(255, 255, 255, 0.15) !important;
  }
  
  [data-theme="dark"] #nav a:hover,
  [data-theme="dark"] #nav button:hover {
    background-color: rgba(0, 0, 0, 0.15) !important;
  }
</style>
<link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 8.1.1"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://hexo.anheyu.com/" title="博客"><img class="back-menu-item-icon" src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">Yuejin's Blog</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI-Platform/" style="font-size: 1.05rem;">AI Platform<sup>1</sup></a><a href="/tags/Database/" style="font-size: 1.05rem;">Database<sup>12</sup></a><a href="/tags/English/" style="font-size: 1.05rem;">English<sup>1</sup></a><a href="/tags/RNN/" style="font-size: 1.05rem;">RNN<sup>1</sup></a><a href="/tags/SQL/" style="font-size: 1.05rem;">SQL<sup>6</sup></a><a href="/tags/Self-Attention/" style="font-size: 1.05rem;">Self Attention<sup>1</sup></a><a href="/tags/plan/" style="font-size: 1.05rem;">plan<sup>2</sup></a><a href="/tags/%E5%85%B3%E7%B3%BB%E6%A8%A1%E5%9E%8B/" style="font-size: 1.05rem;">关系模型<sup>1</sup></a><a href="/tags/%E8%87%AA%E6%B3%A8%E6%84%8F%E5%8A%9B/" style="font-size: 1.05rem;">自注意力<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/12/"><span class="card-archive-list-date">December 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">20</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url">数据库</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Database/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Database</span></a></span></div></div><h1 class="post-title" itemprop="name headline">§16 Query Optimization 解读</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-12-27T17:13:55.730Z" title="发表于 2025-12-28 01:13:55">2025-12-28</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-12-27T17:24:03.366Z" title="更新于 2025-12-28 01:24:03">2025-12-28</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为北京"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>北京</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="/img/C7_cover.png"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://example.com/2025/12/28/DB_QueryOptim/"><header><a class="post-meta-categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url">数据库</a><a href="/tags/Database/" tabindex="-1" itemprop="url">Database</a><h1 id="CrawlerTitle" itemprop="name headline">§16 Query Optimization 解读</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Yuejin Wu</span><time itemprop="dateCreated datePublished" datetime="2025-12-27T17:13:55.730Z" title="发表于 2025-12-28 01:13:55">2025-12-28</time><time itemprop="dateCreated datePublished" datetime="2025-12-27T17:24:03.366Z" title="更新于 2025-12-28 01:24:03">2025-12-28</time></header><h3 id="数据库查询优化-讲义">数据库查询优化  讲义</h3>
<h2 id="第一章：查询优化概述">第一章：查询优化概述</h2>
<h3 id="1-1-查询优化的必要性与定义">1.1 查询优化的必要性与定义</h3>
<h4 id="1-1-1-问题背景">1.1.1 问题背景</h4>
<p>在数据库系统中，一个SQL查询语句可以对应<strong>多个等价的关系代数表达式</strong>。例如，连接操作的顺序不同、选择操作的位置不同，都会产生不同的执行路径。这些不同的执行路径在实际执行时会产生<strong>显著不同的代价</strong>，包括磁盘I/O次数、CPU处理时间、内存使用量等。</p>
<h4 id="1-1-2-查询优化的核心目标">1.1.2 查询优化的核心目标</h4>
<p><strong>查询优化</strong>就是数据库管理系统（DBMS）在多个等价的执行计划中，自动选择并生成一个<strong>代价最低或接近最低的评估计划</strong>的过程。其根本目的是在保证查询结果正确的前提下，最小化查询执行的总成本。</p>
<h4 id="1-1-3-示例：一个简单查询的多种可能">1.1.3 示例：一个简单查询的多种可能</h4>
<p>考虑一个简单的连接查询：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> r, s <span class="keyword">WHERE</span> r.A <span class="operator">=</span> s.A;</span><br></pre></td></tr></table></figure>
<p>这个查询至少对应两种关系代数表达式：</p>
<ol>
<li>先做笛卡尔积再做选择：$\sigma_{r.A = s.A}(r \times s)$</li>
<li>直接做等值连接：$r \bowtie_{r.A = s.A} s$</li>
</ol>
<p>显然，第二种方式（直接连接）的效率远高于第一种（先做代价高昂的笛卡尔积）。查询优化器的任务之一，就是避免生成第一种低效的计划。</p>
<h3 id="1-2-评估计划的组成">1.2 评估计划的组成</h3>
<p>一个完整的<strong>评估计划</strong>需要明确两件事：</p>
<ol>
<li>
<p><strong>操作算法</strong>：为计划中的每个关系代数操作（选择、投影、连接等）选择具体的实现算法。</p>
<ul>
<li>例如，选择操作是用线性扫描还是索引扫描？连接操作是用嵌套循环、归并连接还是哈希连接？</li>
</ul>
</li>
<li>
<p><strong>执行协调</strong>：确定操作之间的执行协调方式。</p>
<ul>
<li>是采用<strong>物化</strong>策略（将中间结果临时存储到磁盘），还是采用<strong>流水线</strong>策略（一个操作的输出直接作为下一个操作的输入）？</li>
</ul>
</li>
</ol>
<p><strong>图示示例：一个包含流水线的评估计划</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">       Π_&#123;name, title&#125; (去除重复)</span><br><span class="line">               |</span><br><span class="line">         (归并连接 Merge Join)</span><br><span class="line">               |</span><br><span class="line">        ---------------</span><br><span class="line">       |               |</span><br><span class="line">  (流水线)         (流水线)</span><br><span class="line">       |               |</span><br><span class="line">Π_&#123;ID, name&#125;     Π_&#123;course_id, title&#125;</span><br><span class="line">       |               |</span><br><span class="line">σ_&#123;dept_name=&#x27;Music&#x27;&#125;   (使用索引1)</span><br><span class="line">       |               |</span><br><span class="line">  instructor          course</span><br></pre></td></tr></table></figure>
<p><em>图：一个包含了归并连接、流水线传递和索引访问的查询评估计划示例</em></p>
<h3 id="1-3-查询优化的三阶段流程">1.3 查询优化的三阶段流程</h3>
<p>查询优化是一个系统化的过程，通常分为三个阶段：</p>
<h4 id="阶段一：生成等价表达式">阶段一：生成等价表达式</h4>
<ul>
<li><strong>输入</strong>：由查询解析器产生的初始关系代数表达式或查询树。</li>
<li><strong>过程</strong>：应用一系列<strong>等价规则</strong>（如选择下推、连接交换律等），对初始表达式进行变换，生成一系列在逻辑上等价的候选表达式。</li>
<li><strong>输出</strong>：一组等价的查询树/表达式集合。</li>
</ul>
<h4 id="阶段二：生成候选评估计划">阶段二：生成候选评估计划</h4>
<ul>
<li><strong>过程</strong>：为第一阶段生成的每个等价表达式，<strong>标注</strong>上具体的物理操作算法和协调策略。
<ul>
<li>例如，标注某个选择操作使用&quot;在<code>salary</code>属性上的B+树索引查找（算法A2）&quot;。</li>
<li>标注两个关系的连接使用&quot;基于哈希的连接算法&quot;。</li>
</ul>
</li>
<li><strong>输出</strong>：一组完整的、可执行的<strong>候选评估计划</strong>。</li>
</ul>
<h4 id="阶段三：选择最优计划">阶段三：选择最优计划</h4>
<ul>
<li><strong>过程</strong>：基于数据库系统的<strong>统计信息</strong>（如关系的大小、属性的取值分布、索引的存在等），估算每个候选计划的执行代价。</li>
<li><strong>方法</strong>：
<ol>
<li><strong>基于代价的优化</strong>：建立一个代价模型，精确或近似计算每个计划的代价，选择最小的。</li>
<li><strong>启发式优化</strong>：应用一系列经验规则（“启发式”），快速选择一个大概率较优的计划，不进行精确的代价比较。</li>
</ol>
</li>
<li><strong>输出</strong>：一个被选中的、优化后的查询评估计划，交由查询执行引擎运行。</li>
</ul>
<h2 id="第二章：关系表达式的等价转换">第二章：关系表达式的等价转换</h2>
<h3 id="2-1-等价性的严格定义">2.1 等价性的严格定义</h3>
<p>两个关系代数表达式 $E_1$ 和 $E_2$ 是<strong>等价的</strong>，记作 $E_1 \equiv E_2$，当且仅当对于<strong>任何合法的数据库实例</strong>（即任何符合模式的数据集合），$E_1$ 和 $E_2$ 的计算结果都产生<strong>完全相同的元组集合</strong>（包括顺序，如果考虑有序关系）。</p>
<p>等价转换是查询优化的代数基础，它保证了我们变换查询形式时，不会改变查询结果的正确性。</p>
<h3 id="2-2-核心等价规则详解">2.2 核心等价规则详解</h3>
<h4 id="规则1：选择操作的串接律-Cascading-of-Selections"><strong>规则1：选择操作的串接律 (Cascading of Selections)</strong></h4>
<ul>
<li><strong>公式</strong>：$\sigma_{\theta_1 \wedge \theta_2}(E) = \sigma_{\theta_1}(\sigma_{\theta_2}(E))$</li>
<li><strong>含义</strong>：一个包含AND（合取）的选择条件，可以拆分为两个连续的选择操作。顺序可以任意。</li>
<li><strong>作用</strong>：为后续将单个选择条件下推到表达式树的不同分支创造条件。</li>
<li><strong>示例</strong>：查找工资高于5万且属于计算机系的教师。
<ul>
<li>原式：$\sigma_{salary&gt;50000 \wedge dept_name=‘Comp. Sci.’}(instructor)$</li>
<li>可转换为：$\sigma_{salary&gt;50000}(\sigma_{dept_name=‘Comp. Sci.’}(instructor))$</li>
</ul>
</li>
</ul>
<h4 id="规则2：选择操作的交换律-Commutativity-of-Selections"><strong>规则2：选择操作的交换律 (Commutativity of Selections)</strong></h4>
<ul>
<li><strong>公式</strong>：$\sigma_{\theta_1}(\sigma_{\theta_2}(E)) = \sigma_{\theta_2}(\sigma_{\theta_1}(E))$</li>
<li><strong>含义</strong>：多个连续选择操作的执行顺序可以任意交换。</li>
<li><strong>作用</strong>：结合规则1，使得优化器可以灵活地安排选择条件的评估顺序，例如将选择性更强（能过滤掉更多元组）的条件先执行。</li>
</ul>
<h4 id="规则3：投影操作的串接律-Cascading-of-Projections"><strong>规则3：投影操作的串接律 (Cascading of Projections)</strong></h4>
<ul>
<li><strong>公式</strong>：若 $L_1 \subseteq L_2 \subseteq … \subseteq L_n$，则<br>
$\Pi_{L_1}(\Pi_{L_2}(…(\Pi_{L_n}(E))…)) = \Pi_{L_1}(E)$</li>
<li><strong>含义</strong>：如果一串投影操作中，每个后续的投影属性列表都包含前一个的，那么只有最后一个投影是必要的。</li>
<li><strong>作用</strong>：在优化过程中，可以消除中间不必要的投影操作。</li>
<li><strong>示例</strong>：只需要教师的ID。
<ul>
<li>原式：$\Pi_{ID}(\Pi_{ID, name}(instructor))$</li>
<li>可简化为：$\Pi_{ID}(instructor)$</li>
</ul>
</li>
</ul>
<h4 id="规则4：用连接操作替代选择和笛卡尔积"><strong>规则4：用连接操作替代选择和笛卡尔积</strong></h4>
<p>这是将低效操作转换为高效操作的关键规则。</p>
<ul>
<li><strong>公式4a</strong>：$\sigma_\theta(E_1 \times E_2) = E_1 \bowtie_\theta E_2$</li>
<li><strong>公式4b</strong>：更一般地，选择条件可以下推到笛卡尔积的一个操作数上：<br>
$\sigma_{\theta_1 \wedge \theta_2}(E_1 \times E_2) = (\sigma_{\theta_1}(E_1)) \bowtie_{\theta_2} E_2$<br>
其中 $\theta_1$ 只涉及 $E_1$ 的属性，$\theta_2$ 是连接条件或涉及两个关系的条件。</li>
<li><strong>含义与作用</strong>：优化器应<strong>始终避免显式生成笛卡尔积</strong>。任何计划中如果出现笛卡尔积后接选择，都应转换为等价的连接操作。连接算法（如嵌套循环、哈希、归并）的效率远高于计算完整的笛卡尔积。</li>
<li><strong>示例</strong>：查询Music系的教师及其授课信息。
<ul>
<li>低效原式（理论上，优化器应避免生成）：$\sigma_{instructor.dept_name=‘Music’ \wedge <a target="_blank" rel="noopener" href="http://instructor.ID=teaches.ID">instructor.ID=teaches.ID</a>}(instructor \times teaches)$</li>
<li>优化后：$\sigma_{dept_name=‘Music’}(instructor) \bowtie_{ID} teaches$</li>
</ul>
</li>
</ul>
<h4 id="规则5：连接操作的交换律-Commutativity-of-Theta-Joins"><strong>规则5：连接操作的交换律 (Commutativity of Theta Joins)</strong></h4>
<ul>
<li><strong>公式</strong>：$E_1 \bowtie_\theta E_2 = E_2 \bowtie_\theta E_1$</li>
<li><strong>含义</strong>：连接操作的左右操作数可以交换。</li>
<li><strong>作用</strong>：这对于选择连接顺序至关重要。它允许优化器将<strong>尺寸较小的关系</strong>作为连接操作的<strong>外关系</strong>。</li>
<li><strong>性能分析</strong>：
<ul>
<li>考虑嵌套循环连接：外层关系<code>r</code>有<code>m</code>个元组，内层关系<code>s</code>有<code>n</code>个元组。</li>
<li>如果<code>s</code>有基于连接属性<code>A</code>的B+树索引，则连接代价约为 $O(m + m \log_d n)$，其中<code>d</code>是B+树的度。</li>
<li>如果<code>r</code>有索引，则代价约为 $O(n + n \log_d m)$。</li>
<li><strong>结论</strong>：应将<strong>元组数少的关系作为外关系</strong>。因为<code>m</code>或<code>n</code>的系数是1，而乘以对数项的系数是另一个关系的大小。通常让较小的关系驱动循环更优。</li>
<li><strong>形式化推导</strong>：设 $m &lt; n$, $n = k * m$ (k&gt;1)。比较两种顺序的代价差：<br>
$(n + n \lg m) - (m + m \lg n) = (k-1)m \lg m - m \lg k$<br>
当<code>m</code>和<code>k</code>不太小时，该值通常为正，说明 $r \bowtie s$ (小⋈大) 的代价低于 $s \bowtie r$ (大⋈小)。</li>
</ul>
</li>
</ul>
<h4 id="规则6：连接操作的结合律-Associativity-of-Joins"><strong>规则6：连接操作的结合律 (Associativity of Joins)</strong></h4>
<ul>
<li><strong>公式6a（自然连接）</strong>：$(E_1 \bowtie E_2) \bowtie E_3 = E_1 \bowtie (E_2 \bowtie E_3)$</li>
<li><strong>公式6b（θ连接）</strong>：$(E_1 \bowtie_{\theta_1} E_2) \bowtie_{\theta_2 \wedge \theta_3} E_3 = E_1 \bowtie_{\theta_1 \wedge \theta_3} (E_2 \bowtie_{\theta_2} E_3)$
<ul>
<li>其中 $\theta_2$ 只涉及 $E_2$ 和 $E_3$ 的属性。</li>
</ul>
</li>
<li><strong>含义与作用</strong>：多表连接的顺序可以改变。这是<strong>连接顺序优化</strong>的代数基础。通过改变结合顺序，可以优先连接产生较小中间结果的关系对，从而降低整个查询的代价。</li>
</ul>
<h4 id="规则7：选择操作对连接的分配律"><strong>规则7：选择操作对连接的分配律</strong></h4>
<p>这是&quot;尽早执行选择&quot;原则的代数依据。</p>
<ul>
<li><strong>公式7a</strong>：如果选择条件 $\theta_0$ <strong>只涉及</strong> $E_1$ 的属性，则<br>
$\sigma_{\theta_0}(E_1 \bowtie E_2) = (\sigma_{\theta_0}(E_1)) \bowtie E_2$</li>
<li><strong>公式7b</strong>：如果选择条件是合取式 $\theta_1 \wedge \theta_2$，且 $\theta_1$ 只涉及 $E_1$ 的属性，$\theta_2$ 只涉及 $E_2$ 的属性，则<br>
$\sigma_{\theta_1 \wedge \theta_2}(E_1 \bowtie E_2) = (\sigma_{\theta_1}(E_1)) \bowtie (\sigma_{\theta_2}(E_2))$</li>
<li><strong>作用</strong>：将选择操作从连接之后&quot;下推&quot;到连接之前，甚至下推到单个关系上。这能<strong>显著减少参与连接操作的数据量</strong>，是降低连接代价最有效的手段之一。</li>
</ul>
<h4 id="规则8：投影操作对连接的分配律"><strong>规则8：投影操作对连接的分配律</strong></h4>
<p>这是&quot;尽早执行投影&quot;原则的代数依据。</p>
<ul>
<li><strong>公式8a（简单情况）</strong>：设 $L_1$ 是 $E_1$ 的属性子集，$L_2$ 是 $E_2$ 的属性子集。如果连接条件 $\theta$ 涉及的所有属性都包含在 $L_1 \cup L_2$ 中，那么：<br>
$\Pi_{L_1 \cup L_2}(E_1 \bowtie_\theta E_2) = (\Pi_{L_1}(E_1)) \bowtie_\theta (\Pi_{L_2}(E_2))$</li>
<li><strong>公式8b（复杂情况）</strong>：如果连接条件 $\theta$ 涉及一些不在最终投影列表 $L_1 \cup L_2$ 中的属性，那么下推投影时，必须把这些属性也保留下来，否则无法进行连接。
<ul>
<li>设 $L_3$ 是 $E_1$ 中参与连接条件 $\theta$ 但不在 $L_1$ 中的属性。</li>
<li>设 $L_4$ 是 $E_2$ 中参与连接条件 $\theta$ 但不在 $L_2$ 中的属性。</li>
<li>则：<br>
$\Pi_{L_1 \cup L_2}(E_1 \bowtie_\theta E_2) = \Pi_{L_1 \cup L_2}[ (\Pi_{L_1 \cup L_3}(E_1)) \bowtie_\theta (\Pi_{L_2 \cup L_4}(E_2)) ]$</li>
</ul>
</li>
<li><strong>作用</strong>：在连接前就剔除那些后续操作和最终结果都不需要的属性，减少每个元组的大小。这能降低数据在磁盘和内存之间传输的代价，并允许更多的元组装入同一个内存块或缓冲区。</li>
</ul>
<h4 id="规则9-12：集合操作的规则"><strong>规则9-12：集合操作的规则</strong></h4>
<ul>
<li><strong>规则9</strong>：并集(∪)和交集(∩)满足<strong>交换律</strong>；差集(−)不满足。<br>
$E_1 \cup E_2 = E_2 \cup E_1$, $E_1 \cap E_2 = E_2 \cap E_1$</li>
<li><strong>规则10</strong>：并集和交集满足<strong>结合律</strong>。<br>
$(E_1 \cup E_2) \cup E_3 = E_1 \cup (E_2 \cup E_3)$, $(E_1 \cap E_2) \cap E_3 = E_1 \cap (E_2 \cap E_3)$</li>
<li><strong>规则11</strong>：选择操作对并、交、差满足<strong>分配律</strong>。<br>
$\sigma_\theta(E_1 \cup E_2) = \sigma_\theta(E_1) \cup \sigma_\theta(E_2)$<br>
（交和差同理）</li>
<li><strong>规则12</strong>：投影操作对并集满足<strong>分配律</strong>。<br>
$\Pi_L(E_1 \cup E_2) = \Pi_L(E_1) \cup \Pi_L(E_2)$</li>
<li><strong>注意</strong>：投影对交集和差集<strong>不满足</strong>分配律。例如，$\Pi_L(E_1 - E_2) \neq \Pi_L(E_1) - \Pi_L(E_2)$，因为可能有一些元组在投影后变得相同，在右边会被错误地消除。</li>
</ul>
<h3 id="2-3-综合转换示例">2.3 综合转换示例</h3>
<h4 id="示例一：选择下推-Pushing-Selections"><strong>示例一：选择下推 (Pushing Selections)</strong></h4>
<ul>
<li><strong>查询</strong>：找出Music系所有教师的姓名及其所授课程的名称。</li>
<li><strong>初始表达式</strong>（连接后进行选择和投影）：<br>
$\Pi_{name, title}(\sigma_{dept_name=‘Music’}(instructor \bowtie teaches \bowtie \Pi_{course_id, title}(course)))$</li>
<li><strong>应用规则7a</strong>：将选择操作下推到它只涉及的关系上。<br>
$\Pi_{name, title}( (\sigma_{dept_name=‘Music’}(instructor)) \bowtie teaches \bowtie \Pi_{course_id, title}(course) )$</li>
<li><strong>效果</strong>：连接操作<code>instructor ⋈ teaches</code>现在只需处理<code>instructor</code>中属于Music系的一小部分元组，而不是全部，代价大大降低。</li>
</ul>
<h4 id="示例二：结合律与选择下推结合"><strong>示例二：结合律与选择下推结合</strong></h4>
<ul>
<li><strong>查询</strong>：找出在2019年授课的Music系教师的姓名及其课程名称。</li>
<li><strong>初始表达式</strong>：<br>
$\Pi_{name, title}( \sigma_{dept_name=‘Music’ \wedge year=2019}(instructor \bowtie teaches \bowtie \Pi_{course_id, title}(course)) )$</li>
<li><strong>步骤1：应用结合律（规则6）</strong>，明确连接顺序。假设优化器决定先连接<code>instructor</code>和<code>teaches</code>。</li>
<li><strong>步骤2：应用选择分配律（规则7b）</strong>，将合取选择拆开并下推：<br>
$\Pi_{name, title}( (\sigma_{dept_name=‘Music’}(instructor)) \bowtie (\sigma_{year=2019}(teaches)) \bowtie \Pi_{course_id, title}(course) )$</li>
<li><strong>效果</strong>：两个连接操作<code>(σ_instructor) ⋈ (σ_teaches)</code>都在已经被大幅过滤的小关系上进行，效率极高。</li>
</ul>
<h4 id="示例三：投影下推"><strong>示例三：投影下推</strong></h4>
<p>继续<strong>示例一</strong>的优化后表达式：<br>
$\Pi_{name, title}( (\sigma_{dept_name=‘Music’}(instructor)) \bowtie teaches \bowtie \Pi_{course_id, title}(course) )$</p>
<ul>
<li>
<p><strong>分析中间结果模式</strong>：</p>
<ul>
<li><code>σ_{dept\_name='Music'}(instructor)</code> 的模式: <code>(ID, name, dept_name, salary)</code></li>
<li><code>teaches</code> 的模式: <code>(ID, course_id, sec_id, semester, year)</code></li>
<li>它们连接后的模式包含所有属性，但最终我们只需要<code>name</code>和<code>title</code>。<code>title</code>来自<code>course</code>表，通过<code>course_id</code>连接。</li>
</ul>
</li>
<li>
<p><strong>应用投影下推（规则8）</strong>：</p>
<ul>
<li>对<code>instructor</code>分支：最终需要<code>name</code>，连接需要<code>ID</code>。因此投影为 $\Pi_{name, ID}$。</li>
<li>对<code>teaches</code>分支：连接需要<code>ID</code>和<code>course_id</code>，最终结果需要<code>course_id</code>（用于连接<code>course</code>表）。因此投影为 $\Pi_{ID, course_id}$。</li>
<li>对<code>course</code>分支：已投影为 $\Pi_{course_id, title}$。</li>
</ul>
</li>
<li>
<p><strong>最终优化表达式</strong>：<br>
$\Pi_{name, title}( (\Pi_{name, ID}(\sigma_{dept_name=‘Music’}(instructor))) \bowtie (\Pi_{ID, course_id}(teaches)) \bowtie (\Pi_{course_id, title}(course)) )$</p>
</li>
<li>
<p><strong>效果</strong>：每个中间关系都只包含最少的必要属性，数据体积最小化，I/O和内存开销显著降低。</p>
</li>
</ul>
<h2 id="第三章：连接顺序优化">第三章：连接顺序优化</h2>
<h3 id="3-1-问题的重要性">3.1 问题的重要性</h3>
<p>对于涉及多个关系（例如3个以上）的连接查询，可能的连接顺序数量随着关系数增长而呈指数级增长（是卡特兰数）。不同的连接顺序会产生大小差异巨大的中间结果，从而导致总执行代价的天壤之别。</p>
<h3 id="3-2-核心原则">3.2 核心原则</h3>
<p>连接顺序优化的基本原则是：<strong>使执行过程中产生的临时关系最小化</strong>。</p>
<ul>
<li>更小的中间结果意味着：更少的磁盘写入/读取、更少的内存占用、更快的后续处理速度。</li>
<li>实现这一原则的策略是：<strong>优先连接产生最小结果集的关系对</strong>。</li>
</ul>
<h3 id="3-3-基于启发式的连接排序">3.3 基于启发式的连接排序</h3>
<p>虽然没有统计信息时无法精确判断，但一些启发式规则很有用：</p>
<ol>
<li><strong>进行有选择操作的关系优先连接</strong>：如果某个关系上有能大幅过滤元组的选择条件（如<code>dept_name='Music'</code>），那么先对这个关系进行选择，再与其他关系连接。因为选择后关系变小了。</li>
<li><strong>小关系优先连接</strong>：如果已知某些关系本身很小（元组数少），让它们先连接。</li>
<li><strong>使用有索引的外键关系优先连接</strong>：如果一个关系可以通过索引快速连接到另一个关系，这种连接方式成本较低，可以优先考虑。</li>
</ol>
<h3 id="3-4-结合统计信息的动态规划算法（简述）">3.4 结合统计信息的动态规划算法（简述）</h3>
<p>在实际的基于代价的优化器中（如System R的优化器），常使用动态规划算法来选择多表连接顺序：</p>
<ol>
<li><strong>基础</strong>：对于单个关系，最佳计划就是访问它的最佳方式（全表扫描或索引扫描）。</li>
<li><strong>递推</strong>：对于关系集合S，其最佳连接计划可以通过考察所有将S划分为两个非空子集S1和S2的方式，计算 <code>最佳计划(S1) ⋈ 最佳计划(S2)</code> 的代价，并取最小值。</li>
<li><strong>代价估算</strong>：每一步的代价估算都需要利用数据库的统计信息，如：
<ul>
<li>每个关系R的元组数 $|R|$</li>
<li>每个属性A的不同值数量 $V(A, R)$</li>
<li>属性的最小值/最大值</li>
<li>索引的深度、叶节点数等</li>
</ul>
</li>
<li><strong>剪枝</strong>：搜索空间巨大，需要利用代价上界等进行剪枝。</li>
</ol>
<h2 id="第四章：评估计划的选择与启发式优化">第四章：评估计划的选择与启发式优化</h2>
<h3 id="4-1-查询优化的最终任务">4.1 查询优化的最终任务</h3>
<p>为给定的关系代数表达式生成一个<strong>物理执行计划</strong>，该计划：</p>
<ol>
<li><strong>逻辑正确</strong>：能产生与原表达式完全相同的结果。</li>
<li><strong>代价较低</strong>：相较于其他候选计划，其预估执行代价较小。</li>
<li><strong>可执行</strong>：明确了每个操作的算法和资源使用方式。</li>
</ol>
<h3 id="4-2-启发式优化：基于经验的快速优化">4.2 启发式优化：基于经验的快速优化</h3>
<p>由于基于代价的优化搜索空间大、统计信息可能不准或缺失，<strong>启发式优化</strong>是一种实用且高效的替代方案。它不追求数学上的最优解，而是应用一套经验证明有效的规则，快速得到一个&quot;足够好&quot;的计划。</p>
<h4 id="4-2-1-核心启发式规则"><strong>4.2.1 核心启发式规则</strong></h4>
<ol>
<li>
<p><strong>尽早执行选择操作 (Perform selection early)</strong>：</p>
<ul>
<li>理由：选择操作通常能大幅减少元组数量。元组越少，后续所有操作（投影、连接、集合操作）的代价都越低。</li>
<li>实现：利用规则1, 2, 7，将σ操作尽可能下推到查询树的叶节点。</li>
</ul>
</li>
<li>
<p><strong>尽早执行投影操作 (Perform projection early)</strong>：</p>
<ul>
<li>理由：投影操作减少每个元组的宽度（属性数）。更窄的元组意味着在磁盘和内存间传输时，每个块能容纳更多元组，减少I/O次数；同样大小的内存缓冲区能容纳更多元组。</li>
<li>实现：利用规则3, 8，在保证连接条件属性不丢失的前提下，将Π操作下推。</li>
</ul>
</li>
<li>
<p><strong>用连接操作替代笛卡尔积 (Replace Cartesian product by join)</strong>：</p>
<ul>
<li>理由：笛卡尔积的代价是乘积级的 $O(|R|*|S|)$，而等值连接的代价可以低很多（如有索引可到 $O(|R| * log|S|)$ 级别）。</li>
<li>实现：利用规则4，优化器在生成计划时应避免任何显式的笛卡尔积，总是直接生成连接。</li>
</ul>
</li>
<li>
<p><strong>先执行最严格的操作 (Perform the most restrictive operation first)</strong>：</p>
<ul>
<li>理由：&quot;最严格&quot;的操作指能产生最小输出结果的操作。先执行它们能为后续操作创造更小的输入。</li>
<li>实现：结合统计信息或简单启发式（如等值条件通常比范围条件严格，小表上的选择比大表上的选择严格），对操作排序。</li>
</ul>
</li>
</ol>
<h4 id="4-2-2-启发式优化的系统化步骤"><strong>4.2.2 启发式优化的系统化步骤</strong></h4>
<p>可以将启发式规则整合为一个系统化的查询树转换流程：</p>
<p><strong>步骤1：分解合取选择</strong></p>
<ul>
<li>应用规则1，将形如 $\sigma_{\theta_1 \wedge \theta_2 \wedge …}(E)$ 的表达式分解为一系列单个选择 $\sigma_{\theta_1}(\sigma_{\theta_2}(… (E)…))$。</li>
<li><strong>目的</strong>：为每个独立的选择条件下推创造条件。</li>
</ul>
<p><strong>步骤2：选择操作下推</strong></p>
<ul>
<li>对查询树从根到叶进行遍历。</li>
<li>对于每一个选择操作 $\sigma_\theta$：
<ul>
<li>应用规则2（交换律）和规则7（分配律），尝试将其下推穿过其子操作（如连接、笛卡尔积、并集等）。</li>
<li>目标是让每个 $\sigma_\theta$ 都尽可能靠近叶节点，最终作用在单个基关系上。</li>
</ul>
</li>
<li><strong>目的</strong>：实现&quot;尽早选择&quot;。</li>
</ul>
<p><strong>步骤3：重新安排叶节点（连接顺序）</strong></p>
<ul>
<li>应用规则5（交换律）和规则6（结合律），对查询树中的叶节点（基关系）进行重新排序。</li>
<li><strong>启发式</strong>：将具有<strong>最严格选择条件</strong>（即能产生最小结果集）的关系，安排在连接顺序中尽可能早的位置。</li>
<li><strong>目的</strong>：让连接操作从一开始就在小关系上进行。</li>
</ul>
<p><strong>步骤4：用连接替代笛卡尔积和选择</strong></p>
<ul>
<li>查找查询树中任何&quot;笛卡尔积(×)后接选择(σ)&quot;的模式。</li>
<li>应用规则4，将其直接替换为一个θ连接操作(⋈)。</li>
<li><strong>目的</strong>：消除代价极高的笛卡尔积。</li>
</ul>
<p><strong>步骤5：投影操作下推</strong></p>
<ul>
<li>对查询树从根到叶进行遍历。</li>
<li>对于每一个投影操作 $\Pi_L$：
<ul>
<li>应用规则3（串接律消除冗余投影）和规则8（分配律），尝试将其下推。</li>
<li>下推时需特别注意保留连接条件所需的属性（规则8b的复杂情况）。</li>
</ul>
</li>
<li><strong>目的</strong>：实现&quot;尽早投影&quot;，减少数据体积。</li>
</ul>
<h3 id="4-3-综合示例分析">4.3 综合示例分析</h3>
<h4 id="示例一：查询成绩-90的男生姓名"><strong>示例一：查询成绩&gt;90的男生姓名</strong></h4>
<p><strong>1. 数据库模式：</strong></p>
<ul>
<li><code>S(S#, sname, age, sex)</code></li>
<li><code>SC(S#, C#, grade)</code></li>
</ul>
<p><strong>2. SQL查询：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> sname</span><br><span class="line"><span class="keyword">FROM</span> S, SC</span><br><span class="line"><span class="keyword">WHERE</span> S.s# <span class="operator">=</span> SC.s# <span class="keyword">AND</span> sex<span class="operator">=</span><span class="string">&#x27;M&#x27;</span> <span class="keyword">AND</span> grade <span class="operator">&gt;</span> <span class="number">90</span>;</span><br></pre></td></tr></table></figure>
<p><strong>3. 初始关系代数表达式（可能由解析器生成）：</strong><br>
$E1 = \Pi_{sname}(\sigma_{S.s#=SC.s# \wedge sex=‘M’ \wedge grade&gt;90}(S \times SC))$</p>
<p><em>注意：这里出现了笛卡尔积，是优化器需要消除的低效形式。</em></p>
<p><strong>4. 启发式优化过程：</strong></p>
<ul>
<li>
<p><strong>Step 0 (假设更优的初始表达式)</strong>：实际优化器可能直接生成带连接的表达式：<br>
$E1’ = \Pi_{sname}(\sigma_{sex=‘M’ \wedge grade&gt;90}(S \bowtie_{S.s#=SC.s#} SC))$<br>
我们从这个更合理的起点开始优化。</p>
</li>
<li>
<p><strong>Step 1 &amp; 2: 选择下推</strong></p>
<ul>
<li>应用规则7b：$\sigma_{sex=‘M’ \wedge grade&gt;90}(S \bowtie SC) = (\sigma_{sex=‘M’}(S)) \bowtie (\sigma_{grade&gt;90}(SC))$</li>
<li>得到：$E2 = \Pi_{sname}( (\sigma_{sex=‘M’}(S)) \bowtie_{S.s#=SC.s#} (\sigma_{grade&gt;90}(SC)) )$</li>
</ul>
</li>
<li>
<p><strong>Step 5: 投影下推</strong></p>
<ul>
<li>分析：最终需要<code>sname</code>。连接条件是<code>S.s#=SC.s#</code>。因此：
<ul>
<li>对S分支：需要<code>sname</code>和<code>s#</code>。投影为 $\Pi_{sname, s#}$</li>
<li>对SC分支：连接需要<code>s#</code>。最终结果不需要SC的任何属性，但连接需要<code>s#</code>。投影为 $\Pi_{s#}$（但注意<code>grade&gt;90</code>的选择条件需要<code>grade</code>属性，所以投影必须在选择之后进行，且选择条件需要<code>grade</code>，所以投影无法完全下推到选择之前。这里我们先做选择，再做投影）。</li>
</ul>
</li>
<li>更精确的转换：利用规则8b。
<ul>
<li>设最终投影列表 L = {sname}。</li>
<li>对于左子树 $\sigma_{sex=‘M’}(S)$：需要保留属性 L1 = {sname}，以及连接属性 L3 = {s#}。所以先投影为 $\Pi_{sname, s#}$（但选择条件<code>sex='M'</code>不需要额外属性，所以顺序可以是：$\Pi_{sname, s#}(\sigma_{sex=‘M’}(S))$）。</li>
<li>对于右子树 $\sigma_{grade&gt;90}(SC)$：最终结果不需要它的属性，连接属性 L4 = {s#}。所以先投影为 $\Pi_{s#}$（但选择条件<code>grade&gt;90</code>需要<code>grade</code>，所以实际是：$\Pi_{s#}(\sigma_{grade&gt;90}(SC))$）。</li>
</ul>
</li>
<li>最终优化表达式：<br>
$E4 = \Pi_{sname}( (\Pi_{sname, s#}(\sigma_{sex=‘M’}(S))) \bowtie_{S.s#=SC.s#} (\Pi_{s#}(\sigma_{grade&gt;90}(SC))) )$</li>
</ul>
</li>
</ul>
<p><strong>5. 最终优化的查询树：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">          Π_&#123;sname&#125;</span><br><span class="line">              |</span><br><span class="line">          ⋈_&#123;S.s#=SC.s#&#125;</span><br><span class="line">         /            \</span><br><span class="line">        /              \</span><br><span class="line">Π_&#123;sname, s#&#125;         Π_&#123;s#&#125;</span><br><span class="line">       |                  |</span><br><span class="line">σ_&#123;sex=&#x27;M&#x27;&#125;           σ_&#123;grade&gt;90&#125;</span><br><span class="line">       |                  |</span><br><span class="line">       S                  SC</span><br></pre></td></tr></table></figure>
<h4 id="示例二：保险数据库查询"><strong>示例二：保险数据库查询</strong></h4>
<p><strong>1. 数据库模式：</strong></p>
<ul>
<li><code>Person(driver-id, name, address)</code></li>
<li><code>Participated(driver-id, license, report-number, damage-amount)</code></li>
<li><code>Accident(report-number, date, location)</code></li>
<li><code>Car(...)</code> <em>（本查询未使用）</em></li>
</ul>
<p><strong>2. SQL查询：</strong> 找出2024年5月3日前在北京发生的交通事故的驾驶员姓名、车牌号和事故报告编号。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> name, license, Accident.report<span class="operator">-</span>number</span><br><span class="line"><span class="keyword">FROM</span> Person, Participated, Accident</span><br><span class="line"><span class="keyword">WHERE</span> Person.driver_id <span class="operator">=</span> Participated.driver_id</span><br><span class="line">  <span class="keyword">AND</span> Accident.report_number <span class="operator">=</span> Participated.report_number</span><br><span class="line">  <span class="keyword">AND</span> location<span class="operator">=</span><span class="string">&#x27;Beijing&#x27;</span></span><br><span class="line">  <span class="keyword">AND</span> <span class="type">date</span> <span class="operator">&lt;</span> <span class="string">&#x27;2024-05-03&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><strong>3. 优化过程与最终查询树：</strong></p>
<ul>
<li><strong>选择下推</strong>：将 <code>location='Beijing' AND date&lt;'2024-05-03'</code> 下推到 <code>Accident</code> 表。</li>
<li><strong>投影下推</strong>（在连接前仅保留必要属性）：
<ul>
<li><code>Person</code> 表：最终需要<code>name</code>，连接需要<code>driver_id</code>。投影为 $\Pi_{driver_id, name}$</li>
<li><code>Participated</code> 表：连接需要<code>driver_id</code>和<code>report_number</code>，最终需要<code>license</code>。投影为 $\Pi_{driver_id, license, report_number}$</li>
<li><code>Accident</code> 表：连接需要<code>report_number</code>，选择需要<code>location</code>和<code>date</code>，最终需要<code>report_number</code>。投影为 $\Pi_{report_number}$（但选择条件需要<code>location, date</code>，所以先选择，再投影：$\Pi_{report_number}(\sigma_{location=‘Beijing’ ∧ date&lt;…}(Accident))$）</li>
</ul>
</li>
<li><strong>连接顺序</strong>：由于<code>Accident</code>经过严格选择后可能变得很小，可以优先与<code>Participated</code>连接。</li>
<li><strong>最终优化查询树</strong>：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">          Π_&#123;name, license, report-number&#125;</span><br><span class="line">                       |</span><br><span class="line">             ⋈_&#123;A.report# = P.report#&#125;</span><br><span class="line">            /                           \</span><br><span class="line">           /                             \</span><br><span class="line">Π_&#123;driver-id, name&#125;               ⋈_&#123;P.driver-id = Per.driver-id&#125;</span><br><span class="line">       |                                  |</span><br><span class="line">     Person                         --------------</span><br><span class="line">                                     /             \</span><br><span class="line">                                    /               \</span><br><span class="line">                      Π_&#123;driver-id, license, report#&#125;   Π_&#123;report#&#125;</span><br><span class="line">                               |                             |</span><br><span class="line">                         Participated               σ_&#123;loc=&#x27;Beijing&#x27;∧date&lt;...&#125;</span><br><span class="line">                                                          |</span><br><span class="line">                                                      Accident</span><br></pre></td></tr></table></figure>
<h4 id="示例四：银行数据库复杂查询"><strong>示例四：银行数据库复杂查询</strong></h4>
<p><strong>1. 数据库模式：</strong></p>
<ul>
<li><code>branch(branch-name, branch-city, assets)</code></li>
<li><code>loan(loan-number, branch-name, amount)</code></li>
<li><code>borrower(customer-name, loan-number, borrow-date)</code></li>
</ul>
<p><strong>2. SQL查询：</strong> 找出在Brooklyn市、资产超过10万美元的分行中，办理了贷款金额小于1000美元的客户姓名。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> customer<span class="operator">-</span>name</span><br><span class="line"><span class="keyword">FROM</span> borrower, loan, branch</span><br><span class="line"><span class="keyword">WHERE</span> loan.loan<span class="operator">-</span>number <span class="operator">=</span> borrower.loan<span class="operator">-</span>number</span><br><span class="line">  <span class="keyword">AND</span> branch.branch<span class="operator">-</span>name <span class="operator">=</span> loan.branch<span class="operator">-</span>name</span><br><span class="line">  <span class="keyword">AND</span> branch<span class="operator">-</span>city<span class="operator">=</span><span class="string">&#x27;Brooklyn&#x27;</span></span><br><span class="line">  <span class="keyword">AND</span> assets <span class="operator">&gt;</span> <span class="number">100000</span></span><br><span class="line">  <span class="keyword">AND</span> amount <span class="operator">&lt;</span> <span class="number">1000</span>;</span><br></pre></td></tr></table></figure>
<p><strong>3. 两种视角的优化方案：</strong></p>
<ul>
<li>
<p><strong>方案一：逻辑优化（关系代数层面）</strong></p>
<ul>
<li><strong>选择下推</strong>：
<ul>
<li>$\sigma_{branch-city=‘Brooklyn’ ∧ assets&gt;100000}$ 下推到 <code>branch</code> 表。</li>
<li>$\sigma_{amount&lt;1000}$ 下推到 <code>loan</code> 表。</li>
</ul>
</li>
<li><strong>投影下推</strong>：
<ul>
<li><code>branch</code> 表：连接需要<code>branch-name</code>，最终结果不需要它的属性。投影为 $\Pi_{branch-name}$（选择条件需要<code>branch-city, assets</code>，所以先选择再投影）。</li>
<li><code>loan</code> 表：连接需要<code>loan-number</code>和<code>branch-name</code>，最终结果不需要它的属性。投影为 $\Pi_{loan-number, branch-name}$（选择条件需要<code>amount</code>）。</li>
<li><code>borrower</code> 表：连接需要<code>loan-number</code>，最终需要<code>customer-name</code>。投影为 $\Pi_{customer-name, loan-number}$。</li>
</ul>
</li>
<li><strong>连接顺序</strong>：可以 $(\sigma_branch) \bowtie (\sigma_loan)$ 先连接（产生在特定分行的、小额贷款的列表），再与 <code>borrower</code> 连接获取客户名。</li>
<li><strong>优化查询树（逻辑）</strong>：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">          Π_&#123;customer-name&#125;</span><br><span class="line">                  |</span><br><span class="line">          ⋈_&#123;loan.loan# = borrower.loan#&#125;</span><br><span class="line">         /                                  \</span><br><span class="line">        /                                    \</span><br><span class="line">Π_&#123;customer-name, loan#&#125;              ⋈_&#123;branch.branch-name = loan.branch-name&#125;</span><br><span class="line">      |                                      |</span><br><span class="line">  borrower                            --------------</span><br><span class="line">                                       /             \</span><br><span class="line">                                      /               \</span><br><span class="line">                          Π_&#123;loan#, branch-name&#125;        Π_&#123;branch-name&#125;</span><br><span class="line">                                  |                            |</span><br><span class="line">                          σ_&#123;amount&lt;1000&#125;              σ_&#123;branch-city=&#x27;Brooklyn&#x27; ∧ assets&gt;100000&#125;</span><br><span class="line">                                  |                            |</span><br><span class="line">                                loan                          branch</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p><strong>方案二：物理优化（结合存储和索引）</strong><br>
假设有以下物理结构：</p>
<ul>
<li><code>branch</code> 表：在 <code>(branch-city, assets)</code> 上有复合B+树索引。访问方式：<strong>索引查找(Index Seek)</strong> 找到满足条件的<code>branch-name</code>列表。</li>
<li><code>loan</code> 表：在 <code>amount</code> 上有B+树索引，在 <code>branch-name</code> 上有索引。访问方式：对 <code>amount&lt;1000</code> 进行<strong>索引扫描(Index Scan)</strong>，再与来自<code>branch</code>的<code>branch-name</code>列表进行过滤（可能用嵌套循环连接）。</li>
<li><code>borrower</code> 表：堆文件，在 <code>loan-number</code> 上有非聚簇索引。</li>
<li><strong>物理执行计划可能描述为</strong>：
<ol>
<li>对 <code>branch</code> 使用索引查找，得到结果集B（<code>branch-name</code>列表）。</li>
<li>对 <code>loan</code> 使用在 <code>amount</code> 上的索引扫描，对每个扫描到的元组，检查其 <code>branch-name</code> 是否在集合B中（<strong>嵌套循环内连接</strong>），并通过 <code>loan-number</code> 上的索引查找 <code>borrower</code> 表（<strong>索引嵌套循环连接</strong>）。</li>
<li>从找到的 <code>borrower</code> 元组中提取 <code>customer-name</code>。</li>
</ol>
</li>
<li><strong>这个计划充分利用了现有索引，避免了全表扫描，尽管连接算法是嵌套循环，但由于内层有索引支持，效率依然很高。</strong></li>
</ul>
</li>
</ul>
<h2 id="第五章：总结与范畴">第五章：总结与范畴</h2>
<h3 id="5-1-为什么需要查询优化？">5.1 为什么需要查询优化？</h3>
<ul>
<li><strong>性能差异巨大</strong>：同一查询的不同执行计划，其代价可能相差数个数量级。</li>
<li><strong>用户透明性</strong>：让用户专注于声明&quot;要什么&quot;（SQL），而无需操心&quot;怎么要&quot;（执行细节）。</li>
<li><strong>系统资源高效利用</strong>：自动选择最佳计划，节省CPU、I/O和内存资源。</li>
</ul>
<h3 id="5-2-查询优化的三大支柱">5.2 查询优化的三大支柱</h3>
<ol>
<li><strong>关系表达式的等价转换（第16.2章）</strong>：代数基础。通过等价规则生成多个逻辑上等价的候选表达式。</li>
<li><strong>表达式结果的统计信息估算（第16.3章）</strong>：代价估算的基础。需要估算中间结果的大小（基数）、不同值数量、数据分布等。例如：
<ul>
<li>选择操作的结果大小估算：依赖于选择条件的选择率。</li>
<li>连接操作的结果大小估算：依赖于连接属性的域大小和值的分布。</li>
</ul>
</li>
<li><strong>查询执行计划的选择（第16.4章）</strong>：综合应用前两者，从候选计划中选出代价最低的。</li>
</ol>
<h3 id="5-3-优化方法分类">5.3 优化方法分类</h3>
<ul>
<li><strong>基于代价的优化</strong>：
<ul>
<li>优点：理论上能找到最优解。</li>
<li>缺点：搜索空间大，依赖准确的统计信息，优化过程本身有开销。</li>
<li>适用于：对性能要求极高、数据分布稳定的OLAP场景。</li>
</ul>
</li>
<li><strong>启发式优化</strong>：
<ul>
<li>优点：简单、快速、开销小，不依赖精确统计信息。</li>
<li>缺点：可能错过最优计划，得到的是&quot;较好&quot;而非&quot;最好&quot;的计划。</li>
<li>适用于：OLTP场景或统计信息缺失时。</li>
</ul>
</li>
<li><strong>现代优化器</strong>：通常结合两者，先使用启发式规则大幅缩小搜索空间，再在剩余空间内进行基于代价的精细选择。</li>
</ul>
<h3 id="5-4-相关高级主题">5.4 相关高级主题</h3>
<ul>
<li><strong>物化视图（第16.5章）</strong>：将某些常用查询（尤其是包含聚集、连接的复杂查询）的结果预先计算并存储为真实的表。查询优化器可以重写用户查询，使其直接访问物化视图，从而避免昂贵的连接和计算开销。</li>
<li><strong>嵌套子查询优化</strong>：
<ul>
<li>问题：SQL中的嵌套子查询（如<code>IN</code>, <code>EXISTS</code>, <code>&gt; ALL</code>等）通常以低效的&quot;逐行处理&quot;方式执行。</li>
<li>优化：将嵌套子查询&quot;去相关化&quot;，转换为等价的连接操作，从而可以利用连接优化技术。</li>
<li>例如：<code>SELECT * FROM r WHERE r.A IN (SELECT s.A FROM s)</code> 可以转换为 <code>SELECT DISTINCT r.* FROM r JOIN s ON r.A = s.A</code>。</li>
</ul>
</li>
</ul>
<p>通过学习本章内容，读者应能深入理解数据库查询优化器的工作原理，从而能够：</p>
<ol>
<li>编写更能被优化器高效处理的SQL语句。</li>
<li>理解数据库给出的执行计划，并据此进行性能调优。</li>
<li>在设计数据库模式（如索引、物化视图）时，考虑其对查询优化的影响。</li>
</ol>
<p><strong>—— 讲义结束 ——</strong></p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src="/img/my_avatar.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src="/img/my_avatar.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">Yuejin Wu</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/2025/12/28/DB_QueryOptim/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/2025/12/28/DB_QueryOptim/')">§16 Query Optimization 解读</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/2025/12/28/DB_QueryOptim/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=§16 Query Optimization 解读&amp;url=http://example.com/2025/12/28/DB_QueryOptim/&amp;pic=/img/C7_cover.png" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Yuejin's Blog</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="categoryes-punctuation"> <i class="anzhiyufont anzhiyu-icon-inbox"></i></span>数据库<span class="categoryesPageCount">12</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Database/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Database<span class="tagsPageCount">12</span></a></div></div><div class="post_share"><div class="social-share" data-image="/img/C7_cover.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/12/28/DB_QueryProcessing/"><img class="prev-cover" src="/img/C7_cover.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">§15 Query Processing 简读</div></div></a></div><div class="next-post pull-right"><a href="/2025/12/28/DB_Transaction/"><img class="next-cover" src="/img/C7_cover.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">§17 Transaction 解读</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2025/12/27/DB_Indexing/" title="§14 Indexing 解读"><img class="cover" src="/img/C7_cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-12-27</div><div class="title">§14 Indexing 解读</div></div></a></div><div><a href="/2025/12/24/DB_Intermediate%20SQL/" title="§4 Intermediate-SQL 解读"><img class="cover" src="/img/SQL_cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-12-24</div><div class="title">§4 Intermediate-SQL 解读</div></div></a></div><div><a href="/2025/12/24/DB_AdvancedSQL/" title="§5 Advanced-SQL课件详解"><img class="cover" src="/img/SQL_cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-12-24</div><div class="title">§5 Advanced-SQL课件详解</div></div></a></div><div><a href="/2025/12/26/DB_E-R%20Model/" title="§6 E-R Model 解读"><img class="cover" src="/img/ER_cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-12-26</div><div class="title">§6 E-R Model 解读</div></div></a></div><div><a href="/2025/12/22/DB_SQL%20%E8%AF%AD%E8%A8%80%E7%AE%80%E8%AF%BB/" title="§3 Intro-to-SQL 简读"><img class="cover" src="/img/SQL_cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-12-22</div><div class="title">§3 Intro-to-SQL 简读</div></div></a></div><div><a href="/2025/12/28/DB_QueryProcessing/" title="§15 Query Processing 简读"><img class="cover" src="/img/C7_cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-12-28</div><div class="title">§15 Query Processing 简读</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info-avatar"><img class="avatar-img" src="/img/my_avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__description"><div class="author-intro" style="line-height: 1.7; text-align: center; font-family: inherit; margin-top: -0.5rem; margin-bottom: 0.5rem;">
  <p style="font-size: 1.15rem; margin-bottom: 0.8rem; font-weight: 500; color: var(--anzhiyu-fontcolor);">你好，我是 <span style="color: #00ffcc; font-weight: 600; text-shadow: 0 0 5px #00ffccaa;">Yuejin Wu</span>！👋</p>
  <p style="font-size: 1.05rem; margin-bottom: 0.6rem; opacity: 0.9; color: var(--anzhiyu-fontcolor);">BUPT 本科生 · 人工智能专业</p>
  <p style="font-size: 1.05rem; margin-bottom: 1rem; opacity: 0.9; color: var(--anzhiyu-fontcolor);">记录学习、思考与生活</p>
  <p style="font-size: 1.1rem; margin-top: 1rem; padding-top: 0.8rem; border-top: 1px solid var(--anzhiyu-theme-op); font-weight: 600; color: #FF0066; text-shadow: 0 0 5px #FF0066, 0 0 5px #FF0066aa;">
   保持好奇，持续探索
  </p>
</div>
</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Yuejin Wu</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/YuejinWu/YuejinWu.github.io" target="_blank" title="Github"></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96-%E8%AE%B2%E4%B9%89"><span class="toc-number">1.</span> <span class="toc-text">数据库查询优化  讲义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0%EF%BC%9A%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E6%A6%82%E8%BF%B0"><span class="toc-number">2.</span> <span class="toc-text">第一章：查询优化概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7%E4%B8%8E%E5%AE%9A%E4%B9%89"><span class="toc-number">2.1.</span> <span class="toc-text">1.1 查询优化的必要性与定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-1-%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.1.1 问题背景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-2-%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E7%9A%84%E6%A0%B8%E5%BF%83%E7%9B%AE%E6%A0%87"><span class="toc-number">2.1.2.</span> <span class="toc-text">1.1.2 查询优化的核心目标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-3-%E7%A4%BA%E4%BE%8B%EF%BC%9A%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E6%9F%A5%E8%AF%A2%E7%9A%84%E5%A4%9A%E7%A7%8D%E5%8F%AF%E8%83%BD"><span class="toc-number">2.1.3.</span> <span class="toc-text">1.1.3 示例：一个简单查询的多种可能</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E8%AF%84%E4%BC%B0%E8%AE%A1%E5%88%92%E7%9A%84%E7%BB%84%E6%88%90"><span class="toc-number">2.2.</span> <span class="toc-text">1.2 评估计划的组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E7%9A%84%E4%B8%89%E9%98%B6%E6%AE%B5%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">1.3 查询优化的三阶段流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B6%E6%AE%B5%E4%B8%80%EF%BC%9A%E7%94%9F%E6%88%90%E7%AD%89%E4%BB%B7%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">2.3.1.</span> <span class="toc-text">阶段一：生成等价表达式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B6%E6%AE%B5%E4%BA%8C%EF%BC%9A%E7%94%9F%E6%88%90%E5%80%99%E9%80%89%E8%AF%84%E4%BC%B0%E8%AE%A1%E5%88%92"><span class="toc-number">2.3.2.</span> <span class="toc-text">阶段二：生成候选评估计划</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B6%E6%AE%B5%E4%B8%89%EF%BC%9A%E9%80%89%E6%8B%A9%E6%9C%80%E4%BC%98%E8%AE%A1%E5%88%92"><span class="toc-number">2.3.3.</span> <span class="toc-text">阶段三：选择最优计划</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0%EF%BC%9A%E5%85%B3%E7%B3%BB%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E7%AD%89%E4%BB%B7%E8%BD%AC%E6%8D%A2"><span class="toc-number">3.</span> <span class="toc-text">第二章：关系表达式的等价转换</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%AD%89%E4%BB%B7%E6%80%A7%E7%9A%84%E4%B8%A5%E6%A0%BC%E5%AE%9A%E4%B9%89"><span class="toc-number">3.1.</span> <span class="toc-text">2.1 等价性的严格定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%A0%B8%E5%BF%83%E7%AD%89%E4%BB%B7%E8%A7%84%E5%88%99%E8%AF%A6%E8%A7%A3"><span class="toc-number">3.2.</span> <span class="toc-text">2.2 核心等价规则详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%84%E5%88%991%EF%BC%9A%E9%80%89%E6%8B%A9%E6%93%8D%E4%BD%9C%E7%9A%84%E4%B8%B2%E6%8E%A5%E5%BE%8B-Cascading-of-Selections"><span class="toc-number">3.2.1.</span> <span class="toc-text">规则1：选择操作的串接律 (Cascading of Selections)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%84%E5%88%992%EF%BC%9A%E9%80%89%E6%8B%A9%E6%93%8D%E4%BD%9C%E7%9A%84%E4%BA%A4%E6%8D%A2%E5%BE%8B-Commutativity-of-Selections"><span class="toc-number">3.2.2.</span> <span class="toc-text">规则2：选择操作的交换律 (Commutativity of Selections)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%84%E5%88%993%EF%BC%9A%E6%8A%95%E5%BD%B1%E6%93%8D%E4%BD%9C%E7%9A%84%E4%B8%B2%E6%8E%A5%E5%BE%8B-Cascading-of-Projections"><span class="toc-number">3.2.3.</span> <span class="toc-text">规则3：投影操作的串接律 (Cascading of Projections)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%84%E5%88%994%EF%BC%9A%E7%94%A8%E8%BF%9E%E6%8E%A5%E6%93%8D%E4%BD%9C%E6%9B%BF%E4%BB%A3%E9%80%89%E6%8B%A9%E5%92%8C%E7%AC%9B%E5%8D%A1%E5%B0%94%E7%A7%AF"><span class="toc-number">3.2.4.</span> <span class="toc-text">规则4：用连接操作替代选择和笛卡尔积</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%84%E5%88%995%EF%BC%9A%E8%BF%9E%E6%8E%A5%E6%93%8D%E4%BD%9C%E7%9A%84%E4%BA%A4%E6%8D%A2%E5%BE%8B-Commutativity-of-Theta-Joins"><span class="toc-number">3.2.5.</span> <span class="toc-text">规则5：连接操作的交换律 (Commutativity of Theta Joins)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%84%E5%88%996%EF%BC%9A%E8%BF%9E%E6%8E%A5%E6%93%8D%E4%BD%9C%E7%9A%84%E7%BB%93%E5%90%88%E5%BE%8B-Associativity-of-Joins"><span class="toc-number">3.2.6.</span> <span class="toc-text">规则6：连接操作的结合律 (Associativity of Joins)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%84%E5%88%997%EF%BC%9A%E9%80%89%E6%8B%A9%E6%93%8D%E4%BD%9C%E5%AF%B9%E8%BF%9E%E6%8E%A5%E7%9A%84%E5%88%86%E9%85%8D%E5%BE%8B"><span class="toc-number">3.2.7.</span> <span class="toc-text">规则7：选择操作对连接的分配律</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%84%E5%88%998%EF%BC%9A%E6%8A%95%E5%BD%B1%E6%93%8D%E4%BD%9C%E5%AF%B9%E8%BF%9E%E6%8E%A5%E7%9A%84%E5%88%86%E9%85%8D%E5%BE%8B"><span class="toc-number">3.2.8.</span> <span class="toc-text">规则8：投影操作对连接的分配律</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%84%E5%88%999-12%EF%BC%9A%E9%9B%86%E5%90%88%E6%93%8D%E4%BD%9C%E7%9A%84%E8%A7%84%E5%88%99"><span class="toc-number">3.2.9.</span> <span class="toc-text">规则9-12：集合操作的规则</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E7%BB%BC%E5%90%88%E8%BD%AC%E6%8D%A2%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.3.</span> <span class="toc-text">2.3 综合转换示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%B8%80%EF%BC%9A%E9%80%89%E6%8B%A9%E4%B8%8B%E6%8E%A8-Pushing-Selections"><span class="toc-number">3.3.1.</span> <span class="toc-text">示例一：选择下推 (Pushing Selections)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BA%8C%EF%BC%9A%E7%BB%93%E5%90%88%E5%BE%8B%E4%B8%8E%E9%80%89%E6%8B%A9%E4%B8%8B%E6%8E%A8%E7%BB%93%E5%90%88"><span class="toc-number">3.3.2.</span> <span class="toc-text">示例二：结合律与选择下推结合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%B8%89%EF%BC%9A%E6%8A%95%E5%BD%B1%E4%B8%8B%E6%8E%A8"><span class="toc-number">3.3.3.</span> <span class="toc-text">示例三：投影下推</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0%EF%BC%9A%E8%BF%9E%E6%8E%A5%E9%A1%BA%E5%BA%8F%E4%BC%98%E5%8C%96"><span class="toc-number">4.</span> <span class="toc-text">第三章：连接顺序优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E9%97%AE%E9%A2%98%E7%9A%84%E9%87%8D%E8%A6%81%E6%80%A7"><span class="toc-number">4.1.</span> <span class="toc-text">3.1 问题的重要性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E6%A0%B8%E5%BF%83%E5%8E%9F%E5%88%99"><span class="toc-number">4.2.</span> <span class="toc-text">3.2 核心原则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%9F%BA%E4%BA%8E%E5%90%AF%E5%8F%91%E5%BC%8F%E7%9A%84%E8%BF%9E%E6%8E%A5%E6%8E%92%E5%BA%8F"><span class="toc-number">4.3.</span> <span class="toc-text">3.3 基于启发式的连接排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E7%BB%93%E5%90%88%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF%E7%9A%84%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92%E7%AE%97%E6%B3%95%EF%BC%88%E7%AE%80%E8%BF%B0%EF%BC%89"><span class="toc-number">4.4.</span> <span class="toc-text">3.4 结合统计信息的动态规划算法（简述）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0%EF%BC%9A%E8%AF%84%E4%BC%B0%E8%AE%A1%E5%88%92%E7%9A%84%E9%80%89%E6%8B%A9%E4%B8%8E%E5%90%AF%E5%8F%91%E5%BC%8F%E4%BC%98%E5%8C%96"><span class="toc-number">5.</span> <span class="toc-text">第四章：评估计划的选择与启发式优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E7%9A%84%E6%9C%80%E7%BB%88%E4%BB%BB%E5%8A%A1"><span class="toc-number">5.1.</span> <span class="toc-text">4.1 查询优化的最终任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%90%AF%E5%8F%91%E5%BC%8F%E4%BC%98%E5%8C%96%EF%BC%9A%E5%9F%BA%E4%BA%8E%E7%BB%8F%E9%AA%8C%E7%9A%84%E5%BF%AB%E9%80%9F%E4%BC%98%E5%8C%96"><span class="toc-number">5.2.</span> <span class="toc-text">4.2 启发式优化：基于经验的快速优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-%E6%A0%B8%E5%BF%83%E5%90%AF%E5%8F%91%E5%BC%8F%E8%A7%84%E5%88%99"><span class="toc-number">5.2.1.</span> <span class="toc-text">4.2.1 核心启发式规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-%E5%90%AF%E5%8F%91%E5%BC%8F%E4%BC%98%E5%8C%96%E7%9A%84%E7%B3%BB%E7%BB%9F%E5%8C%96%E6%AD%A5%E9%AA%A4"><span class="toc-number">5.2.2.</span> <span class="toc-text">4.2.2 启发式优化的系统化步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E7%BB%BC%E5%90%88%E7%A4%BA%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">5.3.</span> <span class="toc-text">4.3 综合示例分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%B8%80%EF%BC%9A%E6%9F%A5%E8%AF%A2%E6%88%90%E7%BB%A9-90%E7%9A%84%E7%94%B7%E7%94%9F%E5%A7%93%E5%90%8D"><span class="toc-number">5.3.1.</span> <span class="toc-text">示例一：查询成绩&gt;90的男生姓名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BA%8C%EF%BC%9A%E4%BF%9D%E9%99%A9%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9F%A5%E8%AF%A2"><span class="toc-number">5.3.2.</span> <span class="toc-text">示例二：保险数据库查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E5%9B%9B%EF%BC%9A%E9%93%B6%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%8D%E6%9D%82%E6%9F%A5%E8%AF%A2"><span class="toc-number">5.3.3.</span> <span class="toc-text">示例四：银行数据库复杂查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0%EF%BC%9A%E6%80%BB%E7%BB%93%E4%B8%8E%E8%8C%83%E7%95%B4"><span class="toc-number">6.</span> <span class="toc-text">第五章：总结与范畴</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%EF%BC%9F"><span class="toc-number">6.1.</span> <span class="toc-text">5.1 为什么需要查询优化？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E7%9A%84%E4%B8%89%E5%A4%A7%E6%94%AF%E6%9F%B1"><span class="toc-number">6.2.</span> <span class="toc-text">5.2 查询优化的三大支柱</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E4%BC%98%E5%8C%96%E6%96%B9%E6%B3%95%E5%88%86%E7%B1%BB"><span class="toc-number">6.3.</span> <span class="toc-text">5.3 优化方法分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E7%9B%B8%E5%85%B3%E9%AB%98%E7%BA%A7%E4%B8%BB%E9%A2%98"><span class="toc-number">6.4.</span> <span class="toc-text">5.4 相关高级主题</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/12/28/DB_Transaction/" title="§17 Transaction 解读"><img src="/img/C7_cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="§17 Transaction 解读"/></a><div class="content"><a class="title" href="/2025/12/28/DB_Transaction/" title="§17 Transaction 解读">§17 Transaction 解读</a><time datetime="2025-12-27T17:32:13.329Z" title="发表于 2025-12-28 01:32:13">2025-12-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/28/DB_QueryOptim/" title="§16 Query Optimization 解读"><img src="/img/C7_cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="§16 Query Optimization 解读"/></a><div class="content"><a class="title" href="/2025/12/28/DB_QueryOptim/" title="§16 Query Optimization 解读">§16 Query Optimization 解读</a><time datetime="2025-12-27T17:13:55.730Z" title="发表于 2025-12-28 01:13:55">2025-12-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/28/DB_QueryProcessing/" title="§15 Query Processing 简读"><img src="/img/C7_cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="§15 Query Processing 简读"/></a><div class="content"><a class="title" href="/2025/12/28/DB_QueryProcessing/" title="§15 Query Processing 简读">§15 Query Processing 简读</a><time datetime="2025-12-27T16:13:06.413Z" title="发表于 2025-12-28 00:13:06">2025-12-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/27/DB_Indexing/" title="§14 Indexing 解读"><img src="/img/C7_cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="§14 Indexing 解读"/></a><div class="content"><a class="title" href="/2025/12/27/DB_Indexing/" title="§14 Indexing 解读">§14 Indexing 解读</a><time datetime="2025-12-27T13:25:49.244Z" title="发表于 2025-12-27 21:25:49">2025-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/27/DB_%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84/" title="§13 Data Storage Structures 简读"><img src="/img/C7_cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="§13 Data Storage Structures 简读"/></a><div class="content"><a class="title" href="/2025/12/27/DB_%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84/" title="§13 Data Storage Structures 简读">§13 Data Storage Structures 简读</a><time datetime="2025-12-27T08:01:17.698Z" title="发表于 2025-12-27 16:01:17">2025-12-27</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2025 By <a class="footer-bar-link" href="/" title="Yuejin Wu" target="_blank">Yuejin Wu</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" href="/" title="首页">首页</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">20</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">9</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">8</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://hexo.anheyu.com/" title="博客"><img class="back-menu-item-icon" src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI-Platform/" style="font-size: 0.88rem;">AI Platform<sup>1</sup></a><a href="/tags/Database/" style="font-size: 0.88rem;">Database<sup>12</sup></a><a href="/tags/English/" style="font-size: 0.88rem;">English<sup>1</sup></a><a href="/tags/RNN/" style="font-size: 0.88rem;">RNN<sup>1</sup></a><a href="/tags/SQL/" style="font-size: 0.88rem;">SQL<sup>6</sup></a><a href="/tags/Self-Attention/" style="font-size: 0.88rem;">Self Attention<sup>1</sup></a><a href="/tags/plan/" style="font-size: 0.88rem;">plan<sup>2</sup></a><a href="/tags/%E5%85%B3%E7%B3%BB%E6%A8%A1%E5%9E%8B/" style="font-size: 0.88rem;">关系模型<sup>1</sup></a><a href="/tags/%E8%87%AA%E6%B3%A8%E6%84%8F%E5%8A%9B/" style="font-size: 0.88rem;">自注意力<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@6.1.6/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.7.0",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 Yuejin Wu 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://cdn.cbd.int/qrcodejs@1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>